<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Dashboard - Itens da Sess√£o {{ sessao.nome }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    {% load static %}
    <link rel="stylesheet" href="{% static 'css/listar_itens.css' %}" />
</head>
<body>

    <!-- Sidebar -->
    <aside class="sidebar">
        <h2>Dashboard</h2>
        <a href="{% url 'listar_sessoes' %}" class="btn btn-outline-light w-100 mb-3">‚Üê Voltar para Sess√µes</a>
        <button class="btn btn-success w-100 mb-3" data-bs-toggle="modal" data-bs-target="#modalCadastrarItem">
            ‚ûï Adicionar Item
        </button>

        <a href="{% url 'gerar_relatorio_pdf' sessao.id %}" class="btn btn-success w-100 mb-3" target="_blank">
            üìù Gerar Relat√≥rio PDF
        </a>


    </aside>
    

    <!-- Main content -->
    <main class="main-content">
    <header class="main-header">
        Itens da Sess√£o <span class="session-name">{{ sessao.nome }}</span>
    </header>

    <!-- Pesquisa -->
    <input type="text" id="pesquisaItem" placeholder="Pesquisar item..." aria-label="Pesquisar item" />

    <section class="cards-container" id="listaItens">
        {% for item in itens %}
        <article class="card-item" data-nome="{{ item.nome|lower }}">
            <header class="card-header card-blue d-flex justify-content-between align-items-center">
                {{ item.nome }}
                <!-- Bot√µes editar e excluir dentro do header -->
                <div class="d-flex gap-2">
                    <a href="{% url 'editar_item' item.id %}" class="btn-editar" title="Editar Item">
                        ‚úèÔ∏è
                    </a>
                    <form action="{% url 'excluir_item' item.id %}" method="post" class="m-0">
                        {% csrf_token %}
                        <button type="submit" class="btn-excluir"
                            onclick="return confirm('Tem certeza que deseja excluir este item?');">
                            ‚úñ
                        </button>
                    </form>
                </div>
            </header>

            <div class="card-body">
                <div class="card-quantity">{{ item.quantidade }} cadastrados</div>

                <h6>Retiradas:</h6>
                <input type="text" class="form-control mb-2" placeholder="Pesquisar quem retirou..." data-item-id="{{ item.id }}" data-type="retirada" />
                <ul class="retirada-list" data-item-id="{{ item.id }}">
                    {% for retirada in item.retiradas.all %}
                    <li data-usuario="{{ retirada.usuario.nome|lower }}">
                        <div class="retirada-info">
                            <strong>{{ retirada.usuario.nome }}</strong> retirou
                            <span class="badge-quantidade">{{ retirada.quantidade }}</span> em
                            <small>{{ retirada.data_retirada|date:"d/m/Y H:i" }}</small>
                        </div>
                        <form method="post" action="{% url 'remover_retirada' retirada.id %}?next={% url 'listar_itens' sessao.id %}" class="form-remover">
                            {% csrf_token %}
                            <input type="number" name="quantidade" min="1" max="{{ retirada.quantidade }}" value="{{ retirada.quantidade }}" required />
                            <button type="submit" title="Remover retirada">‚úñ</button>
                        </form>
                    </li>
                    {% empty %}
                    <li class="text-muted fst-italic">Ningu√©m retirou ainda</li>
                    {% endfor %}
                </ul>

                <form method="post" action="{% url 'retirar_item' item.id %}" class="form-retirar">
                    {% csrf_token %}
                    <label for="usuario-{{ item.id }}">Quem pegou:</label>
                    <input type="text" class="form-control mb-2" placeholder="Pesquisar usu√°rio..." data-item-id="{{ item.id }}" data-type="usuario" autocomplete="off" />
                    <select id="usuario-{{ item.id }}" name="usuario" required data-item-id="{{ item.id }}">
                        {% for usuario in usuarios %}
                        <option value="{{ usuario.id }}" data-nome="{{ usuario.nome|lower }}">{{ usuario.nome }} - {{ usuario.get_graduacao_display }}</option>
                        {% endfor %}
                    </select>

                    <label for="quantidade-{{ item.id }}" class="mt-2">Quantidade:</label>
                    <input id="quantidade-{{ item.id }}" type="number" name="quantidade" min="1" max="{{ item.quantidade }}" value="1" required />

                    <label for="pin_confirmacao-{{ item.id }}" class="mt-2">PIN de Confirma√ß√£o (se definido):</label>
                    <input id="pin_confirmacao-{{ item.id }}" type="password" name="pin_confirmacao" maxlength="4" pattern="\d{4}" placeholder="4 d√≠gitos" />

                    <button type="submit" class="mt-3">Registrar Retirada</button>
                </form>
            </div>
        </article>
        {% empty %}
        <div class="alert alert-info w-100 text-center" role="alert">
            Nenhum item cadastrado ainda.
        </div>
        {% endfor %}
    </section>
</main>


    <!-- Modal para Cadastrar Item -->
    <div class="modal fade" id="modalCadastrarItem" tabindex="-1" aria-labelledby="modalCadastrarItemLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form method="post" action="{% url 'adicionar_item' sessao.id %}">
                    {% csrf_token %}
                    <div class="modal-header">
                        <h5 class="modal-title" id="modalCadastrarItemLabel">Cadastrar Novo Item</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
                    </div>
                    <div class="modal-body">
                        
                        <div class="mb-3">
                            <label for="nomeItem" class="form-label">Nome do Item</label>
                            <input type="text" id="nomeItem" name="nome" class="form-control" required />
                        </div>
                        <div class="mb-3">
                            <label for="quantidadeItem" class="form-label">Quantidade</label>
                            <input type="number" id="quantidadeItem" name="quantidade" class="form-control" min="1" required />
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="submit" class="btn btn-success">Salvar</button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Script de pesquisa -->
    <script>
        const inputPesquisa = document.getElementById("pesquisaItem");
        const listaItens = document.getElementById("listaItens");

        // Armazenar op√ß√µes originais dos selects
        const originalOptions = {};
        document.querySelectorAll('select[data-item-id]').forEach(select => {
            const itemId = select.getAttribute('data-item-id');
            originalOptions[itemId] = Array.from(select.options).map(option => ({
                value: option.value,
                text: option.text,
                nome: option.getAttribute('data-nome')
            }));
        });

        inputPesquisa.addEventListener("input", () => {
            const filtro = inputPesquisa.value.toLowerCase();
            const cards = listaItens.querySelectorAll("article.card-item");

            cards.forEach(card => {
                const nome = card.getAttribute("data-nome");
                if (nome.includes(filtro)) {
                    card.style.display = "";
                } else {
                    card.style.display = "none";
                }
            });
        });

        // Pesquisa dentro dos cards
        document.addEventListener("input", (e) => {
            if (e.target.hasAttribute("data-item-id") && e.target.hasAttribute("data-type")) {
                const itemId = e.target.getAttribute("data-item-id");
                const type = e.target.getAttribute("data-type");
                const filtro = e.target.value.toLowerCase();

                if (type === "retirada") {
                    // Filtrar lista de retiradas
                    const retiradaList = document.querySelector(`ul.retirada-list[data-item-id="${itemId}"]`);
                    const retiradas = retiradaList.querySelectorAll("li[data-usuario]");

                    retiradas.forEach(retirada => {
                        const usuario = retirada.getAttribute("data-usuario");
                        if (usuario.includes(filtro)) {
                            retirada.style.display = "";
                        } else {
                            retirada.style.display = "none";
                        }
                    });
                } else if (type === "usuario") {
                    // Filtrar op√ß√µes do select dinamicamente
                    const select = document.querySelector(`select[data-item-id="${itemId}"]`);
                    select.innerHTML = '';
                    const filtered = originalOptions[itemId].filter(opt => opt.nome.includes(filtro));
                    filtered.forEach(opt => {
                        const option = document.createElement('option');
                        option.value = opt.value;
                        option.text = opt.text;
                        option.setAttribute('data-nome', opt.nome);
                        select.appendChild(option);
                    });
                }
            }
        });
    </script>

</body>
</html>