{% extends 'usuarios/base.html' %}

{% block title %}Painel de Administração{% endblock %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    .page-header {
        background: linear-gradient(135deg, #0d1b2a, #1b263b);
        color: white;
        padding: 2rem 0;
        margin-bottom: 2rem;
        border-radius: 15px;
    }
    .page-title {
        color: white !important;
        text-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }
    .card {
        border-radius: 0.75rem;
        box-shadow: 0 4px 12px rgb(0 0 0 / 0.1);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        background-color: #fff;
        border: none;
    }
    .card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 25px rgb(0 0 0 / 0.15);
    }
    .btn-primary {
        background-color: #3ac569;
        border: none;
        transition: background-color 0.3s ease;
    }
    .btn-primary:hover {
        background-color: #2ea851;
    }
    .btn-danger {
        background-color: #dc3545;
        border: none;
        transition: background-color 0.3s ease;
    }
    .btn-danger:hover {
        background-color: #c82333;
    }
    .table th {
        background-color: #f8f9fa;
        border-top: none;
        font-weight: 600;
        color: #495057;
    }
    .table td {
        vertical-align: middle;
    }
    .stats-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 0.75rem;
        padding: 1.5rem;
        text-align: center;
        box-shadow: 0 4px 12px rgb(0 0 0 / 0.1);
    }
    .stats-card h3 {
        font-size: 2rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
    }
    .stats-card p {
        font-size: 0.9rem;
        opacity: 0.9;
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <div class="container">
        <h1 class="page-title">Dashboard Administrativo</h1>
        <p class="page-subtitle">Gerencie usuários, sessões e visualize estatísticas do sistema</p>
    </div>
</div>

    <main class="container">
        <h1>Dashboard Administrativo</h1>

        <!-- Estatísticas -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="stats-card">
                    <h3>{{ total_itens }}</h3>
                    <p>Total de Itens</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card">
                    <h3>{{ total_retiradas }}</h3>
                    <p>Total de Retiradas</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card">
                    <h3>{{ porcentagem_cautelados }}%</h3>
                    <p>Porcentagem Cautelados</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card">
                    <h3>{{ sessoes_com_mais_retiradas|length }}</h3>
                    <p>Sessões Ativas</p>
                </div>
            </div>
        </div>

        <!-- Sessões -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Sessões</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Nome</th>
                                <th>Criador</th>
                                <th>Data de Criação</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for sessao in sessoes %}
                            <tr>
                                <td>{{ sessao.id }}</td>
                                <td>{{ sessao.nome }}</td>
                                <td>{{ sessao.criador.nome }}</td>
                                <td>{{ sessao.criada_em|date:"d/m/Y H:i" }}</td>
                                <td>
                                    <a href="{% url 'editar_sessao' sessao.id %}" class="btn btn-sm btn-primary me-2">Editar</a>
                                    <a href="{% url 'excluir_sessao' sessao.id %}" class="btn btn-sm btn-danger" onclick="return confirm('Tem certeza que deseja excluir esta sessão?')">Excluir</a>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="5" class="text-center">Nenhuma sessão encontrada.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Usuários -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Usuários</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Nome</th>
                                <th>Email</th>
                                <th>Graduação</th>
                                <th>Admin</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for usuario in usuarios %}
                            <tr>
                                <td>{{ usuario.id }}</td>
                                <td>{{ usuario.nome }}</td>
                                <td>{{ usuario.email }}</td>
                                <td>{{ usuario.graduacao }}</td>
                                <td>{% if usuario.is_admin %}Sim{% else %}Não{% endif %}</td>
                                <td>
                                    <a href="{% url 'editar_usuario' usuario.id %}" class="btn btn-sm btn-primary me-2">Editar</a>
                                    <button class="btn btn-sm btn-danger" onclick="excluirUsuario({{ usuario.id }}, '{{ usuario.nome }}')">Excluir</button>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="6" class="text-center">Nenhum usuário encontrado.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Gráficos -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Sessões com Mais Retiradas</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="sessoesChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Usuários por Graduação</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="usuariosChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Gráfico de Itens por Sessão -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Itens por Sessão</h5>
            </div>
            <div class="card-body">
                <canvas id="itensSessaoChart"></canvas>
            </div>
        </div>
    </main>

    <script>
        // Gráfico de Barras para Sessões
        const sessoesCtx = document.getElementById('sessoesChart').getContext('2d');
        new Chart(sessoesCtx, {
            type: 'bar',
            data: {
                labels: {{ sessoes_labels|safe }},
                datasets: [{
                    label: 'Retiradas',
                    data: {{ sessoes_data|safe }},
                    backgroundColor: 'rgba(54, 162, 235, 0.6)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });

        // Gráfico de Pizza para Usuários por Graduação
        const usuariosCtx = document.getElementById('usuariosChart').getContext('2d');
        new Chart(usuariosCtx, {
            type: 'pie',
            data: {
                labels: {{ usuarios_labels|safe }},
                datasets: [{
                    data: {{ usuarios_data|safe }},
                    backgroundColor: [
                        'rgba(255, 99, 132, 0.6)',
                        'rgba(54, 162, 235, 0.6)',
                        'rgba(255, 205, 86, 0.6)',
                        'rgba(75, 192, 192, 0.6)',
                        'rgba(153, 102, 255, 0.6)'
                    ],
                    borderColor: [
                        'rgba(255, 99, 132, 1)',
                        'rgba(54, 162, 235, 1)',
                        'rgba(255, 205, 86, 1)',
                        'rgba(75, 192, 192, 1)',
                        'rgba(153, 102, 255, 1)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true
            }
        });

        // Gráfico de Barras para Itens por Sessão
        const itensSessaoCtx = document.getElementById('itensSessaoChart').getContext('2d');
        new Chart(itensSessaoCtx, {
            type: 'bar',
            data: {
                labels: {{ itens_sessao_labels|safe }},
                datasets: [{
                    label: 'Itens',
                    data: {{ itens_sessao_data|safe }},
                    backgroundColor: 'rgba(75, 192, 192, 0.6)',
                    borderColor: 'rgba(75, 192, 192, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });

        function excluirUsuario(id, nome) {
            if (confirm(`Tem certeza que deseja excluir o usuário ${nome}?`)) {
                fetch('{% url "excluir_usuario_ajax" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: `usuario_id=${id}`
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert(data.message);
                        location.reload();
                    } else {
                        alert(data.error);
                    }
                });
            }
        }
    </script>
{% endblock %}
